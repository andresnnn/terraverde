<?php
/*
 * Generated by CRUDigniter v3.2
 * www.crudigniter.com
 */
defined('BASEPATH') OR exit('No direct script access allowed');
class Tareas extends Admin_Controller{
    function __construct()
    {



        parent::__construct();
                /* Load :: Common */
        $this->lang->load('admin/tareas');
        /* Title Page :: Common */
        $this->page_title->push(lang('menu_tarea'));
       $this->data['pagetitle'] = $this->page_title->show();
        /* CARGA LA BASE DE DATOS O MODELO*/
       $this->load->model('common/Tareas_model');

        $this->load->model('common/Umbraculos_model');
        $this->load->model('common/Estadotarea_model');
        $this->load->model('common/Plantas_model');
        $this->load->model('common/plantas_model');
        $this->load->model('common/Tipotarea_model');
        $this->load->model('common/Umbraculoplantas_model');/*cargo el modelo para cargar el select de umbraculo-->plantas*/
        $this->load->model('common/Insumos_model');
      /*  $this->load->model('common/Insumotarea_model');*/

      //        $this->load->model('common/plantas_model');

    }

    /*
     * Listing of tarea
     */
    /*function index()
    {
        $data['tarea'] = $this->Tareas_model->get_all_tarea();

        $data['_view'] = 'tareas/index';
        $this->load->view('layouts/main',$data);
    }*/


    public function index()
    {
        if ( ! $this->ion_auth->logged_in() OR ! $this->ion_auth->is_admin())
        {
            redirect('auth/login', 'refresh');
        }
        else
        {
            /* Breadcrumbs */
            $this->data['breadcrumb'] = $this->breadcrumbs->show();
            /* CARGO EL LISTADO DE UMBRACULOS*/



          $this->data['tarea'] = $this->Tareas_model->get_all_tarea_nombres();/*aca iba get_all_tarea*/

          /*cargo modelos*/







            /* Load Template */
            $this->template->admin_render('admin/tareas/index', $this->data);
        }
    }
    /*
     * Adding a new tarea
     */
     function add()
     {
         if ( ! $this->ion_auth->logged_in() OR ! $this->ion_auth->is_admin())
         {
             redirect('auth/login', 'refresh');
         }
         else
         {

             /* Breadcrumbs */
             $this->data['breadcrumb'] = $this->breadcrumbs->show();

             $this->load->library('form_validation');

            /* $this->form_validation->set_rules('idTipoTarea','IdTipoTarea','required|max_length[50]|min_length[5]');*/
            /* $this->form_validation->set_rules('idEstado','IdEstado','required|max_length[255]|min_length[10]');*/
             /*$this->form_validation->set_rules('idUserAtencion','IdUserAtencion','required|max_length[99]');*/
             /*$this->form_validation->set_rules('idUserCreador','IdUserCreador','required|max_length[99]');*/
             $this->form_validation->set_rules('idPlanta','IdPlanta','required');
             $this->form_validation->set_rules('idUmbraculo','IdUmbraculo','required|max_length[99]');
             $this->form_validation->set_rules('idTipoTarea','IdTipoTarea','required|max_length[50]|min_length[5]');/*guarda aca*/
            /* $this->form_validation->set_rules('fechaCreacion','FechaCreacion','required');
             $this->form_validation->set_rules('fechaAtencion','FechaAtencion','required');*/
             $this->form_validation->set_rules('fechaHoraComienzo','FechaHoraComienzo','max_length[50]');
             $this->form_validation->set_rules('observacionEspecialista','ObservacionEspecialista','max_length[50]');

             if($this->form_validation->run())
             {
                 $params = array(
                     /*idTipoTarea' => $this->input->post('idTipoTarea'),
                     /*'idEstado' => $this->input->post('idEstado'),
                     'idUserAtencion' => $this->input->post('idUserAtencion'),
                     'idUserCreador' => $this->input->post('idUserCreador'),*/
                     'idPlanta' => $this->input->post('idPlanta'),
                     'idUmbraculo' => $this->input->post('idUmbraculo'),
                     'idTipoTarea' => $this->input->post('idTipoTarea'),
                     /*'fechaCreacion' => $this->input->post('fechaCreacion'),
                     'fechaAtencion' => $this->input->post('fechaAtencion'),*/
                     'fechaHoraComienzo' => $this->input->post('fechaHoraComienzo'),
                     'observacionEspecialista' => $this->input->post('observacionEspecialista'),
                 );

                 $idTarea = $this->Tareas_model->add_tarea($params);



                 redirect('common/tareas/index');
             }
             else
             {
 $this->load->model('common/Umbraculoplantas_model');
               $this->data['umbraculo_plantas'] = $this->Umbraculoplantas_model->get_all_umbraculo_plantas();/*guarda aca..lo cargo para ver*/

               $this->load->model('common/Plantas_model');
         			$this->data['planta'] = $this->Plantas_model->get_all_plantas();
              $this->load->model('common/Tipotarea_model');
             $this->data['tipotarea'] = $this->Tipotarea_model->get_all_tipotarea();

             $this->load->model('common/Umbraculos_model');
            $this->data['infoUmbraculo'] = $this->Umbraculos_model->get_all_umbraculos();







            $this->load->model('common/Umbraculoplantas_model');
           $this->data['infoUmbraculoplanta'] = $this->Umbraculoplantas_model->get_all_umbraculo_plantas();
           $this->data['infoUmbraculoplantass'] = $this->Umbraculoplantas_model->get_all_umbraculo_plantas('infoUmbraculoplanta');

           $this->data['insumo'] = $this->Insumos_model->get_all_insumo();

                 $this->template->admin_render('admin/tareas/add', $this->data);
             }
         }
     }

  /*  function add()
    {
        if(isset($_POST) && count($_POST) > 0)
        {
            $params = array(
				'idTipoTarea' => $this->input->post('idTipoTarea'),
				'idEstado' => $this->input->post('idEstado'),
				'idUserAtencion' => $this->input->post('idUserAtencion'),
				'idUserCreador' => $this->input->post('idUserCreador'),
				'idPlanta' => $this->input->post('idPlanta'),
				'idUmbraculo' => $this->input->post('idUmbraculo'),
				'fechaCreacion' => $this->input->post('fechaCreacion'),
				'fechaAtencion' => $this->input->post('fechaAtencion'),
				'fechaHoraComienzo' => $this->input->post('fechaHoraComienzo'),
				'observacionEspecialista' => $this->input->post('observacionEspecialista'),
            );

            $tarea_id = $this->Tareas_model->add_tarea($params);
            redirect('tareas/index');
        }
        else
        {
			$this->load->model('Tipotarea_model');
			$data['all_tipotarea'] = $this->Tipotarea_model->get_all_tipotarea();

			$this->load->model('Estado_tarea_model');
			$data['all_estado_tarea'] = $this->Estado_tarea_model->get_all_estado_tarea();

			$this->load->model('User_model');
			$data['all_users'] = $this->User_model->get_all_users();
			$data['all_users'] = $this->User_model->get_all_users();

			$this->load->model('Plantum_model');
			$data['all_planta'] = $this->Plantum_model->get_all_planta();

			$this->load->model('Umbraculo_model');
			$data['all_umbraculo'] = $this->Umbraculo_model->get_all_umbraculo();

            $data['_view'] = 'tareas/add';
            $this->load->view('layouts/main',$data);
        }
    }

    /*
     * Editing a tarea



     */
     function edit($idTarea)
     {
         if ( ! $this->ion_auth->logged_in() OR ! $this->ion_auth->is_admin())
         {
             redirect('auth/login', 'refresh');
         }
         else
         {

                 /* Breadcrumbs */
                 $this->data['breadcrumb'] = $this->breadcrumbs->show();
                 // check if the umbraculos exists before trying to edit it
                  $this->data['tarea'] = $this->Tipotarea_model->get_all_tipotarea();/*guarda*/
                 $this->data['tarea'] = $this->Tareas_model->get_tarea($idTarea);


                 if(isset($this->data['tarea']['idTarea']))
                 {
                     $this->load->library('form_validation');

                     $this->form_validation->set_rules('idTipoTarea','IdTipoTarea','required|max_length[50]|min_length[5]');
                     $this->form_validation->set_rules('idEstado','IdEstado','required|max_length[255]|min_length[10]');
                     $this->form_validation->set_rules('idUserAtencion','IdUserAtencion','required|max_length[99]');
                     $this->form_validation->set_rules('idUserCreador','IdUserCreador','required|max_length[99]');
                     $this->form_validation->set_rules('idPlanta','IdPlanta','required');
                     $this->form_validation->set_rules('idUmbraculo','IdUmbraculo','required|max_length[99]');
                     $this->form_validation->set_rules('fechaCreacion','FechaCreacion','required');
                     $this->form_validation->set_rules('fechaAtencion','FechaAtencion','required');
                     $this->form_validation->set_rules('fechaHoraComienzo','FechaHoraComienzo','max_length[50]');
                     $this->form_validation->set_rules('observacionEspecialista','ObservacionEspecialista','max_length[50]');

                     if($this->form_validation->run())
                     {
                         $params = array(
                           'idTipoTarea' => $this->input->post('idTipoTarea'),
                           'idEstado' => $this->input->post('idEstado'),
                           'idUserAtencion' => $this->input->post('idUserAtencion'),
                           'idUserCreador' => $this->input->post('idUserCreador'),
                           'idPlanta' => $this->input->post('idPlanta'),
                           'idUmbraculo' => $this->input->post('idUmbraculo'),
                           'fechaCreacion' => $this->input->post('fechaCreacion'),
                           'fechaAtencion' => $this->input->post('fechaAtencion'),
                           'fechaHoraComienzo' => $this->input->post('fechaHoraComienzo'),
                           'observacionEspecialista' => $this->input->post('observacionEspecialista'),

                         );

                         $this->Tareas_model->update_tarea($idTarea,$params);
                         redirect('common/tareas/index');
                     }
                     else
                     {
                         $this->template->admin_render('admin/tareas/edit', $this->data);
                     }
                 }
                 else
                     show_error(' no existe.');
         }
     }

     function atender($idTarea)
     {
         if ( ! $this->ion_auth->logged_in() OR ! $this->ion_auth->is_admin())
         {
             redirect('auth/login', 'refresh');
         }
         else
         {

                 /* Breadcrumbs */
                 $this->data['breadcrumb'] = $this->breadcrumbs->show();
                 // check if the umbraculos exists before trying to edit it
                 $this->data['tarea'] = $this->Tareas_model->get_tarea($idTarea);
                 /*$this->data['umbraculoajax'] = $this->Umbraculoplantas_model->get_all_umbraculo_plantas;*/
                 $this->data['planta'] = $this->Tareas_model->get_plantas_nombre($idTarea);/*con esto veo el nombre de la planta de la tarea*/
                /*$this->data['planta'] = $this->Plantas_model->get_planta($idTarea);*/
                $this->data['umbraculo'] = $this->Tareas_model->get_umbraculo_nombre($idTarea);
                $this->data['tipo'] = $this->Tareas_model->get_tipotarea_nombre($idTarea);
                $this->data['estado'] = $this->Tareas_model-> get_estadoTarea_nombre($idTarea);
                $this->data['insumo'] = $this->Insumotarea_model-> get_insumotarea($idTarea);


                 if(isset($this->data['tarea']['idTarea']))
                 {
                     $this->load->library('form_validation');

                     $this->form_validation->set_rules('idTipoTarea','IdTipoTarea','required|max_length[50]|min_length[5]');
                     $this->form_validation->set_rules('idEstado','IdEstado','required|max_length[255]|min_length[10]');
                     $this->form_validation->set_rules('idUserAtencion','IdUserAtencion','required|max_length[99]');
                     $this->form_validation->set_rules('idUserCreador','IdUserCreador','required|max_length[99]');
                     $this->form_validation->set_rules('idPlanta','IdPlanta','required');
                     $this->form_validation->set_rules('idUmbraculo','IdUmbraculo','required|max_length[99]');
                     $this->form_validation->set_rules('fechaCreacion','FechaCreacion','required');
                     $this->form_validation->set_rules('fechaAtencion','FechaAtencion','required');
                     $this->form_validation->set_rules('fechaHoraComienzo','FechaHoraComienzo','max_length[50]');
                     $this->form_validation->set_rules('observacionEspecialista','ObservacionEspecialista','max_length[50]');

                     if($this->form_validation->run())
                     {
                         $params = array(
                           'idTipoTarea' => $this->input->post('idTipoTarea'),
                           'idEstado' => $this->input->post('idEstado'),
                           'idUserAtencion' => $this->input->post('idUserAtencion'),
                           'idUserCreador' => $this->input->post('idUserCreador'),
                           'idPlanta' => $this->input->post('idPlanta'),
                           'idUmbraculo' => $this->input->post('idUmbraculo'),
                           'fechaCreacion' => $this->input->post('fechaCreacion'),
                           'fechaAtencion' => $this->input->post('fechaAtencion'),
                           'fechaHoraComienzo' => $this->input->post('fechaHoraComienzo'),
                           'observacionEspecialista' => $this->input->post('observacionEspecialista'),


                         );

                         $this->Tareas_model->update_tarea($idTarea,$params);
                         redirect('common/tareas/index');
                     }
                     else
                     {
                         $this->template->admin_render('admin/tareas/atender', $this->data);
                     }
                 }
                 else
                     show_error('El umbráculo que esta intentando editar no existe.');
         }
     }


    function editOriginal($idTarea)
    {
        // check if the tarea exists before trying to edit it
        $data['tarea'] = $this->Tareas_model->get_tarea($idTarea);

        if(isset($data['tarea']['idTarea']))
        {
            if(isset($_POST) && count($_POST) > 0)
            {
                $params = array(
					'idTipoTarea' => $this->input->post('idTipoTarea'),
					'idEstado' => $this->input->post('idEstado'),
					'idUserAtencion' => $this->input->post('idUserAtencion'),
					'idUserCreador' => $this->input->post('idUserCreador'),
					'idPlanta' => $this->input->post('idPlanta'),
					'idUmbraculo' => $this->input->post('idUmbraculo'),
					'fechaCreacion' => $this->input->post('fechaCreacion'),
					'fechaAtencion' => $this->input->post('fechaAtencion'),
					'fechaHoraComienzo' => $this->input->post('fechaHoraComienzo'),
					'observacionEspecialista' => $this->input->post('observacionEspecialista'),
                );

                $this->Tareas_model->update_tarea($idTarea,$params);
                redirect('tareas/index');
            }
            else
            {
				$this->load->model('Tipotarea_model');
				$data['all_tipotarea'] = $this->Tipotarea_model->get_all_tipotarea();

				$this->load->model('Estado_tarea_model');
				$data['all_estado_tarea'] = $this->Estado_tarea_model->get_all_estado_tarea();

				$this->load->model('User_model');
				$data['all_users'] = $this->User_model->get_all_users();
				$data['all_users'] = $this->User_model->get_all_users();

				$this->load->model('Plantum_model');
				$data['all_planta'] = $this->Plantum_model->get_all_planta();

				$this->load->model('Umbraculo_model');
				$data['all_umbraculo'] = $this->Umbraculo_model->get_all_umbraculo();

                $data['_view'] = 'tareas/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The tarea you are trying to edit does not exist.');
    }

    /*
     * Deleting tarea
     */
    function remove($idTarea)
    {
        $tarea = $this->Tareas_model->get_tarea($idTarea);

        // check if the tarea exists before trying to delete it
        if(isset($tarea['idTarea']))
        {
            $this->Tareas_model->delete_tarea($idTarea);
            redirect('common/tareas/index'); /*sin common*/
        }
        else
            show_error('La tarea que quiere borrar no existe.');
    }

    public function profile($idTarea)
    {
        if ( ! $this->ion_auth->logged_in() OR ! $this->ion_auth->is_admin())
        {
            redirect('auth/login', 'refresh');
        }
        else
        {
            /* Breadcrumbs */
            $this->data['breadcrumb'] = $this->breadcrumbs->show();

            /* Data */
            $idTarea = (int) $idTarea;


/*aca cargo los modelos e invoco a sus funciones- joins*/
             $this->data['tarea'] = $this->Tareas_model->get_tarea($idTarea);
            /* $this->data['planta'] = $this->Plantas_model->get_nombre_planta($idTarea);*/
             $this->data['planta'] = $this->Tareas_model->get_plantas_nombre($idTarea);/*con esto veo el nombre de la planta de la tarea*/
              /*$this->data['planta'] = $this->Plantas_model->get_planta($idTarea);*/
               $this->data['umbraculo'] = $this->Tareas_model->get_umbraculo_nombre($idTarea);
              $this->data['tipo'] = $this->Tareas_model->get_tipotarea_nombre($idTarea);
            $this->data['estado'] = $this->Tareas_model-> get_estadoTarea_nombre($idTarea);
            $this->data['insumo'] = $this->Insumotarea_model-> get_insumotarea($idTarea);

            /* CARGAR INFORMARCION */
           // $this->load->view('admin/umbraculos/umbraculos_plantas/index',$this->data);

            /* Load Template */
            $this->template->admin_render('admin/tareas/ver', $this->data);
        }
    }

    public function llena_localidades()
{

$options = " ";
if($this->input->post('provincia'))
{
$provincia = $this->input->post('provincia');
$localidades = $this->Umbraculoplantas_model->get_umbraculo_plantas($provincia);
foreach ($localidades as $fila) {
                ?>
                <option value="<?php echo $fila->idPlanta ?>"><?php echo $idPlanta ?></option>

                <?php


}
}
}



}
